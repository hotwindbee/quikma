#!/bin/bash
# author:hotwindbee
# A simple quick set trojan for self.
# Less is More. —— Ludwig Mies van der Rohe
function need() {
    n1="curl xz-utils net-tools"
    apt update && apt install $n1 -y
}
function insAcme() {
    echo "請輸入郵箱/Please enter Email：" 
    read acmeEmail
    curl https://get.acme.sh | sh -s email=$acmeEmail
    source ./.bashrc
    ./.acme.sh/acme.sh --set-default-ca --server letsencrypt
}
function epEmail() {
    echo "請輸入CloudFlare郵箱/Please enter CloudFlare Account："
    read acmeEmail
    export CF_Email="$cfmail"
}
function epKey() {
    echo "請輸入CloudFlarem密鑰/Please enter Cloudflare Global_Key："
    read apikey
    export CF_Key="$apikey"
}
function issueCert() {
    read -p "請要輸入申請證書的域名/Please enter domain which you want issue cert：" domain
    ./.acme.sh/acme.sh --issue --dns dns_cf -d $domain -k ec-256
}
function insCert() {
    rm -rf /usr/quikmaCert && mkdir -p /usr/quikmaCert
    ./.acme.sh/acme.sh --installcert -d $domain --fullchainpath /usr/quikmaCert/fullchain.cer --keypath /usr/quikmaCert/private.key --ecc
    ./.acme.sh/acme.sh --upgrade --auto-upgrade
}
function randomPort() {
    shuf -i 15619-61524 -n 1
}
function randomPassword() {
    tr -dc A-Za-z0-9 </dev/urandom | head -c 12 ; echo ''
}
function insTrojan() {
    bash -c "$(curl -fsSL https://raw.githubusercontent.com/trojan-gfw/trojan-quickstart/master/trojan-quickstart.sh)"
    sed -i '8d' /usr/local/etc/trojan/config.json
    sed -i "8s/.*/\t\t\"$(randomPassword)\"/" /usr/local/etc/trojan/config.json
    sed -i "4s/\"local_port\": [0-9].*/\"local_port\": $(randomPort),/" /usr/local/etc/trojan/config.json
    sed -i 's/\/path\/to\/certificate.crt/\/usr\/quikmaCert\/fullchain.cer/' /usr/local/etc/trojan/config.json
    sed -i 's/\/path\/to\/private.key/\/usr\/quikmaCert\/private.key/' /usr/local/etc/trojan/config.json
}
function begin() {
    systemctl enable trojan
    systemctl restart trojan
}

function bbr() {
    echo "net.core.default_qdisc=fq" >> /etc/sysctl.conf
    echo "net.ipv4.tcp_congestion_control=bbr" >> /etc/sysctl.conf
    sysctl -p
    sysctl net.ipv4.tcp_available_congestion_control
    echo "已啟用BBR/BBR has been enabled。"
}
function setRestartTrojan() {
    (echo "0 6 * * * systemctl restart trojan" ; crontab -l)| crontab 
    echo "已設置每日6點重啟trojan/Trojan has been set to restart at 6:00 every day。"
}
need
insAcme
epEmail
epKey
issueCert
insCert
insTrojan
begin
bbr
setRestartTrojan
ln -s /usr/local/etc/trojan/config.json ~/trojan_config
head -n 10 ~/trojan_config
echo "已完成/Finished。請根据需要修改端口與密碼/Please modify the port and password。"
