#!/bin/bash
# author:hotwindbee
# A simple quick set trojan for self.
# Less is More. —— Ludwig Mies van der Rohe
function need() {
    n1="curl xz-utils net-tools"
    apt update && apt install $n1 -y
}
function insAcme() {
    read -p "請輸入郵箱/Please enter Email：" acmeEmail
    curl https://get.acme.sh | sh -s email=$acmeEmail
}
function epEmail() {
    read -p "請輸入CloudFlare郵箱/Please enter CloudFlare Account：" cfmail
    export CF_Email="$cfmail"
}
function epKey() {
    read -p "請輸入CloudFlarem密鑰/Please enter Cloudflare Global_Key：" apikey
    export CF_Key="$apikey"
}
function issueCert() {
    read -p "請要輸入申請證書的域名/Please enter domain which you want issue cert：" domain
    ./.acme.sh/acme.sh --issue --dns dns_cf -d $domain -k ec-256
}
function insCert() {
    rm -rf /usr/quikmaCert && mkdir -p /usr/quikmaCert
    ./.acme.sh/acme.sh --installcert -d $domain --fullchainpath /usr/quikma/fullchain.cer --keypath /usr/quikma/private.key --ecc
    ./.acme.sh/acme.sh --upgrade --auto-upgrade
}
function begin() {
    systemctl enable trojan
    systemctl restart trojan
}

function bbr() {
    echo "net.core.default_qdisc=fq" >> /etc/sysctl.conf
    echo "net.ipv4.tcp_congestion_control=bbr" >> /etc/sysctl.conf
    sysctl -p
    sysctl net.ipv4.tcp_available_congestion_control
}
need
insAcme
source ./.bashrc
./.acme.sh/acme.sh --set-default-ca --server letsencrypt
epEmail
epKey
issueCert
insCert
bash -c "$(curl -fsSL https://raw.githubusercontent.com/trojan-gfw/trojan-quickstart/master/trojan-quickstart.sh)"
sed -i '8d' /usr/local/etc/trojan/config.json
sed -i "s/password2/wesztghd1rd9/" /usr/local/etc/trojan/config.json
sed -i 's/\/path\/to\/certificate.crt/\/usr\/mycert\/fullchain.cer/' /usr/local/etc/trojan/config.json
sed -i 's/\/path\/to\/private.key/\/usr\/mycert\/private.key/' /usr/local/etc/trojan/config.json
sed -i 's/443/33333/' /usr/local/etc/trojan/config.json
begin
bbr
ln -s /usr/local/etc/trojan/config.json ~/trojan_config
